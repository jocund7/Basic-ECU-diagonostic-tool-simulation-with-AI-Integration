<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <title>UDS Diagnostic Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .panel { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        h2 { margin-top: 0; color: #333; }
        input, button { padding: 8px; margin: 5px 0; }
        button { background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #45a049; }
        .response { background-color: #f5f5f5; padding: 10px; border-radius: 3px; margin-top: 10px; }
        .hex-input { font-family: monospace; }
        
        .error {
    color: #d32f2f;
    background-color: #ffebee;
    padding: 10px;
    border-radius: 4px;
    margin: 5px 0;
    border-left: 3px solid #d32f2f;
}

.response {
    color: #388e3c;
    background-color: #e8f5e9;
    padding: 10px;
    border-radius: 4px;
    margin: 5px 0;
    border-left: 3px solid #388e3c;
}


/* AI Panel */
.ai-panel {
    margin-top: 15px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 4px;
    border-left: 3px solid #6f42c1;
}

.ai-response h4 {
    color: #6f42c1;
    margin-top: 0;
    margin-bottom: 8px;
    font-size: 15px;
}

.ai-content {
    font-size: 14px;
    line-height: 1.5;
}

.response-time {
    font-size: 12px;
    color: #6c757d;
    text-align: right;
    margin-top: 5px;
}
    </style>
</head>
<body>
    <h1>ECU Diagnostic Tool</h1>
    
    <div class="panel">
        <h2>Read Memory</h2>
        <div>
            Address: <input type="text" id="readAddr" class="hex-input" placeholder="e.g., 1000" value="1000">
            Length: <input type="text" id="readLen" placeholder="e.g., 10" value="10">
            <button onclick="readMemory()">Read</button>
        </div>
        <div id="readResponse" class="response"></div>
    </div>
    
    <div class="panel">
        <h2>Write Memory</h2>
        <div>
            Address: <input type="text" id="writeAddr" class="hex-input" placeholder="e.g., 1000" value="1000">
            Value: <input type="text" id="writeValue" class="hex-input" placeholder="e.g., AA BB CC" value="AA BB CC">
            <button onclick="writeMemory()">Write</button>
        </div>
        <div id="writeResponse" class="response"></div>
    </div>
    
    <div class="panel">
        <h2>Read Data by Identifier</h2>
        <div>
            Data ID: <input type="text" id="dataId" class="hex-input" placeholder="e.g., F100" value="F100">
            <button onclick="readDataId()">Read</button>
        </div>
        <div id="dataIdResponse" class="response"></div>
    </div>
    
    <div class="panel">
        <h2>ECU Control</h2>
        <button onclick="ecuReset()">Reset ECU</button>
        <div id="resetResponse" class="response"></div>
    </div>


    <div class="panel">
        <h2>AI Explanation</h2>
        <!-- <div id="aiExplanation" class="response"></div> -->
        <div id="aiExplanation" class="ai-panel"></div>
    
    <script>
       // Helper function to format hex
// function formatHex(input) {
//     return input.replace(/\s+/g, '')  // Remove existing spaces
//                .replace(/([0-9A-Fa-f]{2})/g, '$1 ')  // Add space every 2 chars
//                .trim();
// }

// // Apply to all hex input fields
// document.querySelectorAll('.hex-input').forEach(input => {
//     input.addEventListener('input', function(e) {
//         this.value = formatHex(e.target.value);
//     });
// });

// async function explainUDSResponse(rawHex, context = "") {
//     const explainDiv = document.getElementById('aiExplanation');
//     explainDiv.innerHTML = '<div class="info">ðŸ”„ Consulting AI...</div>';
    
//     try {
//         const response = await fetch('/api/explain_uds', {
//             method: 'POST',
//             headers: { 'Content-Type': 'application/json' },
//             body: JSON.stringify({
//                 raw_response: rawHex,
//                 context: context
//             })
//         });
//         const data = await response.json();
//         explainDiv.innerHTML = `
//             <div class="ai-response">
//                 <h4>ðŸ§  AI Analysis</h4>
//                 <p>${data.explanation.replace(/\n/g, '<br>')}</p>
//             </div>
//         `;
//     } catch (error) {
//         explainDiv.innerHTML = `
//             <div class="error">
//                 Failed to get explanation: ${error.message}
//             </div>
//         `;
//     }
// }

// // Modify displayResponse to include AI explanation
// function displayResponse(elementId, data) {
//     // ... existing code ...
//     explainUDSResponse(data.raw_response, `Operation: ${data.message}`);
// }

//         function displayResponse(elementId, data) {
//     const container = document.getElementById(elementId);
    
//     if (!data.success) {
//         // Error case
//         container.innerHTML = `
//             <div class="error">
//                 <strong>Raw:</strong> ${data.raw_response || 'None'}<br>
//                 ${data.message}
//             </div>
//         `;
//     } else {
//         // Success case
//         container.innerHTML = `
//             <div class="response">
//                 <strong>Raw:</strong> ${data.raw_response || 'None'}<br>
//                 ${data.message}
//             </div>
//         `;
//     }
//     explainUDSResponse(data.raw_response, `Operation: ${data.message}`);
// }
    
// Main display function with AI integration
function displayResponse(elementId, data) {
    const container = document.getElementById(elementId);
    
    // 1. First display the basic response
    container.innerHTML = `
        <div class="${data.success ? 'response' : 'error'}">
            <strong>Raw:</strong> ${data.raw_response || 'None'}<br>
            ${data.message}
        </div>
    `;
    
    // 2. Then trigger AI explanation (only for valid responses)
    if (data.raw_response) {
        triggerAIExplanation(data.raw_response, data.message);
    }
}

// Dedicated AI explanation function
async function triggerAIExplanation(rawHex, context) {
    const explainDiv = document.getElementById('aiExplanation');
    if (!explainDiv) return;  // Safety check
    
    explainDiv.innerHTML = '<div class="info">ðŸ”„ Consulting AI...</div>';
    
    try {
        const response = await fetch('/api/explain_uds', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                raw_response: rawHex,
                context: `Operation: ${context}`
            })
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const { explanation } = await response.json();
        renderAIResponse(explanation);
    } catch (error) {
        explainDiv.innerHTML = `
            <div class="error">
                AI service unavailable: ${error.message}
            </div>
        `;
    }
}

// Clean rendering function
function renderAIResponse(explanation) {
    const explainDiv = document.getElementById('aiExplanation');
    explainDiv.innerHTML = `
        <div class="ai-response">
            <h4>ðŸ§  AI Analysis</h4>
            <div class="ai-content">${formatExplanation(explanation)}</div>
            <div class="response-time">${new Date().toLocaleTimeString()}</div>
        </div>
    `;
}

// Helper for Markdown/formatting
function formatExplanation(text) {
    // Simple formatting if not using marked.js
    return text.replace(/\n/g, '<br>')
              .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
}

        // Update all your API call handlers like this:
        function readMemory() {
            const addr = document.getElementById('readAddr').value;
            const len = document.getElementById('readLen').value;
            
            fetch('/api/read_memory', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ address: addr, length: len })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    displayResponse('readResponse', data);
                } else {
                    displayResponse('readResponse', data);
                }
            });
        }   
        
        function writeMemory() {
            const addr = document.getElementById('writeAddr').value;
            const value = document.getElementById('writeValue').value;
            
            fetch('/api/write_memory', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ address: addr, value: value })
            })
            .then(response => response.json())
            // .then(data => {
            //     document.getElementById('writeResponse').innerText = data.response || 'No response';
            // });
            .then(data => {
                if (data.error) {
                    displayResponse('writeResponse', data);
                } else {
                    displayResponse('writeResponse', data);
                }
            });
        }
        
        function readDataId() {
            const dataId = document.getElementById('dataId').value;
            
            fetch('/api/read_data_id', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data_id: dataId })
            })
            .then(response => response.json())
            // .then(data => {
            //     document.getElementById('dataIdResponse').innerText = data.response || 'No response';
            // });
            .then(data => {
                if (data.error) {
                    displayResponse('dataIdResponse', data);
                } else {
                    displayResponse('dataIdResponse', data);
                }
            });
        }

function ecuReset() {
    fetch('/api/ecu_reset', {
    method: 'POST',
    headers: { 
        'Content-Type': 'application/json'  // Must match exactly
    },
    body: JSON.stringify({})  // Send empty object if no data needed
})
.then(response => {
        console.log("[Frontend] Raw response:", response);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log("[Frontend] Parsed data:", data);
        displayResponse('resetResponse', data);
    })
    .catch(error => {
        console.error("[Frontend] Reset failed:", error);
        responseDiv.innerHTML = `
            <div class="error">
                <strong>Error:</strong> ${error.message}
            </div>
        `;
    });
}
        
    </script>
</body>
</html>