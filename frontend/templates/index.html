<!DOCTYPE html>
<html>
<head>
    <title>UDS Diagnostic Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .panel { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        h2 { margin-top: 0; color: #333; }
        input, button { padding: 8px; margin: 5px 0; }
        button { background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #45a049; }
        .response { background-color: #f5f5f5; padding: 10px; border-radius: 3px; margin-top: 10px; }
        .hex-input { font-family: monospace; }
        
        .error {
    color: #d32f2f;
    background-color: #ffebee;
    padding: 10px;
    border-radius: 4px;
    margin: 5px 0;
    border-left: 3px solid #d32f2f;
}

.response {
    color: #388e3c;
    background-color: #e8f5e9;
    padding: 10px;
    border-radius: 4px;
    margin: 5px 0;
    border-left: 3px solid #388e3c;
}
    </style>
</head>
<body>
    <h1>ECU Diagnostic Tool</h1>
    
    <div class="panel">
        <h2>Read Memory</h2>
        <div>
            Address: <input type="text" id="readAddr" class="hex-input" placeholder="e.g., 1000" value="1000">
            Length: <input type="text" id="readLen" placeholder="e.g., 10" value="10">
            <button onclick="readMemory()">Read</button>
        </div>
        <div id="readResponse" class="response"></div>
    </div>
    
    <div class="panel">
        <h2>Write Memory</h2>
        <div>
            Address: <input type="text" id="writeAddr" class="hex-input" placeholder="e.g., 1000" value="1000">
            Value: <input type="text" id="writeValue" class="hex-input" placeholder="e.g., AA BB CC" value="AA BB CC">
            <button onclick="writeMemory()">Write</button>
        </div>
        <div id="writeResponse" class="response"></div>
    </div>
    
    <div class="panel">
        <h2>Read Data by Identifier</h2>
        <div>
            Data ID: <input type="text" id="dataId" class="hex-input" placeholder="e.g., F100" value="F100">
            <button onclick="readDataId()">Read</button>
        </div>
        <div id="dataIdResponse" class="response"></div>
    </div>
    
    <div class="panel">
        <h2>ECU Control</h2>
        <button onclick="ecuReset()">Reset ECU</button>
        <div id="resetResponse" class="response"></div>
    </div>
    
    <script>
       // Helper function to format hex
// function formatHex(input) {
//     return input.replace(/\s+/g, '')  // Remove existing spaces
//                .replace(/([0-9A-Fa-f]{2})/g, '$1 ')  // Add space every 2 chars
//                .trim();
// }

// // Apply to all hex input fields
// document.querySelectorAll('.hex-input').forEach(input => {
//     input.addEventListener('input', function(e) {
//         this.value = formatHex(e.target.value);
//     });
// });

        function displayResponse(elementId, data) {
    const container = document.getElementById(elementId);
    
    if (!data.success) {
        // Error case
        container.innerHTML = `
            <div class="error">
                <strong>Raw:</strong> ${data.raw_response || 'None'}<br>
                ${data.message}
            </div>
        `;
    } else {
        // Success case
        container.innerHTML = `
            <div class="response">
                <strong>Raw:</strong> ${data.raw_response || 'None'}<br>
                ${data.message}
            </div>
        `;
    }
}
        
        // Update all your API call handlers like this:
        function readMemory() {
            const addr = document.getElementById('readAddr').value;
            const len = document.getElementById('readLen').value;
            
            fetch('/api/read_memory', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ address: addr, length: len })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    displayResponse('readResponse', data);
                } else {
                    displayResponse('readResponse', data);
                }
            });
        }   
        
        function writeMemory() {
            const addr = document.getElementById('writeAddr').value;
            const value = document.getElementById('writeValue').value;
            
            fetch('/api/write_memory', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ address: addr, value: value })
            })
            .then(response => response.json())
            // .then(data => {
            //     document.getElementById('writeResponse').innerText = data.response || 'No response';
            // });
            .then(data => {
                if (data.error) {
                    displayResponse('writeResponse', data);
                } else {
                    displayResponse('writeResponse', data);
                }
            });
        }
        
        function readDataId() {
            const dataId = document.getElementById('dataId').value;
            
            fetch('/api/read_data_id', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data_id: dataId })
            })
            .then(response => response.json())
            // .then(data => {
            //     document.getElementById('dataIdResponse').innerText = data.response || 'No response';
            // });
            .then(data => {
                if (data.error) {
                    displayResponse('dataIdResponse', data);
                } else {
                    displayResponse('dataIdResponse', data);
                }
            });
        }

function ecuReset() {
    fetch('/api/ecu_reset', {
    method: 'POST',
    headers: { 
        'Content-Type': 'application/json'  // Must match exactly
    },
    body: JSON.stringify({})  // Send empty object if no data needed
})
.then(response => {
        console.log("[Frontend] Raw response:", response);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log("[Frontend] Parsed data:", data);
        displayResponse('resetResponse', data);
    })
    .catch(error => {
        console.error("[Frontend] Reset failed:", error);
        responseDiv.innerHTML = `
            <div class="error">
                <strong>Error:</strong> ${error.message}
            </div>
        `;
    });
}
        
    </script>
</body>
</html>